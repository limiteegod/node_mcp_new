var dao = require('mcp_dao');
var dc = dao.dc;

var config = require("mcp_config");
var ec = config.ec;

var esut = require("easy_util");
var log = esut.log;
var dateUtil = esut.dateUtil;


var TicketService = function(){};

/**
 * 出票系统出票成功的回执
 */
TicketService.prototype.printBack = function(ticket, cb) {
    var self = this;
    var table = dc.main.get("tticket");
    var cond = {id: ticket.id, version: ticket.version};
    var data = {status: ticket.status, rNumber: ticket.rNumber,
        version: ticket.version + 1};
    if (ticket.paper) {
        data.paper = 1;
    }
    else
    {
        data.paper = 0;
    }
    data.terminalId = ticket.terminalId;
    data.stubInfo = ticket.stubInfo;
    data.printTime = dateUtil.getCurTime();

    ticket.printTime = data.printTime;  //保存到算奖队列时用
    table.update(cond, {$set:data}, [], function(err, data){
        if(data.affectedRows == 1)
        {
            cb(null, ticket);
        }
        else
        {
            cb(ec.E3002, ticket);
        }
    });
};

module.exports = new TicketService();