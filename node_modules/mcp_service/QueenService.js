var dao = require('mcp_dao');
var dc = dao.dc;

var config = require('mcp_config');
var ec = config.ec;
var prop = config.prop;
var game = config.game;

var cons = require('mcp_cons');
var ticketStatus = cons.ticketStatus;
var printStatus = cons.printStatus;
var userType = cons.userType;
var orderStatus = cons.orderStatus;
var gameType = cons.gameType;

var kvSer = require('./KvService.js');

var QueenService = function(){};

/**
 * 出票成功之后，票据保存到成功队列，竞彩按游戏保存到一个队列就可以了，
 * 其它游戏要按期次划分
 * @param ticket
 * @param cb
 */
QueenService.prototype.ticketSuc = function(ticket, cb)
{
    var colName, queenObj;
    if(game.getInfo(ticket.gameCode).type == gameType.Jingcai)
    {
        colName = 'term_success_ticket_' + ticket.gameCode;
        kvSer.getJcSucQueenId(function(err, data){
            if(data)
            {
                queenObj = {_id:data.value, ticketId:ticket.id, termCode:ticket.termCode,
                    finishedCount:0};
                var table = dc.mg.getConn().collection(colName);
                table.save(queenObj, [], function(err, data){
                    cb(err, null);
                });
            }
            else
            {
                cb(err, null);
            }
        });
    }
    else
    {
        ticket._id = ticket.id;
        queenObj = ticket;
        colName = 'term_draw_ticket_' + ticket.gameCode + "_" + ticket.termCode;
        var table = dc.mg.getConn().collection(colName);
        table.save(queenObj, [], function(err, data){
            cb(err, null);
        });
    }
};

module.exports = new QueenService();