var async = require('async');

var dao = require('mcp_dao');
var dc = dao.dc;

var config = require('mcp_config');
var ec = config.ec;

var transaction = require('./Transaction.js');

var StationService = function(){};


/**
 * 出票成功之后，出票机构获得出票提成
 * @param ticket
 * @param cb
 */
StationService.prototype.printSuccess = function(ticket, cb)
{
    var self = this;
    var stationGameTable = db.get("stationgame");
    var stationTable = db.get("station");
    transaction.run(function(wCb){
        async.waterfall([
            //获得出票机构的提成详细信息
            function(cb)
            {
                var cond = {stationId:ticket.printerStationId, gameCode:ticket.gameCode};
                stationGameTable.findOne(cond, {pFactor:1}, [], function(err, data){
                    if(err)
                    {
                        cb(ec.E9999);
                    }
                    else
                    {
                        if(data)
                        {
                            cb(null, data);
                        }
                        else
                        {
                            cb(ec.E3003);
                        }
                    }
                });
            },
            //获得票据的出票机构
            function(sg, cb){
                var cond = {id:ticket.printerStationId};
                var columns = {version:1, balance:1};
                stationTable.findOne(cond, columns, [], function(err, data){
                    if(err)
                    {
                        cb(ec.E9999);
                    }
                    else
                    {
                        if(data)
                        {
                            cb(null, sg, data);
                        }
                        else
                        {
                            cb(ec.E2035);
                        }
                    }
                });
            },
            //出票机构获得出票提成
            function(sg, station, cb){
                var amount = (sg.pFactor/10000)*ticket.amount;
                var cond = {id:station.id, version:station.version};
                station.balance += amount;
                station.version++;
                var data = {$set:{version:station.version, balance:station.balance}};
                stationTable.update(cond, data, [], function(err, data){
                    if(err)
                    {
                        cb(ec.E9999);
                    }
                    else
                    {
                        if(data.affectedRows == 1)
                        {
                            cb(ec.E0000, station);
                        }
                        else
                        {
                            cb(ec.E9999);
                        }
                    }
                });
            }
        ], function (err, result) {
            wCb(err, result);
        });
    }, function(err, data){
        cb(err, data);
    });
};

StationService.prototype.saleSuccess = function(ticket, cb)
{
    var self = this;
    var stationGameTable = db.get("stationgame");
    var stationTable = db.get("station");
    async.waterfall([
        //get station game
        function(cb)
        {
            stationGameTable.find({stationId:ticket.stationId, gameCode:ticket.gameCode},
                {pFactor:1}).toArray(function(err, data){
                    cb(null, data[0]);
                });
        },
        //sale station get the money
        function(sg, cb)
        {
            log.info(sg);
            var amount = (sg.rFactor/10000)*ticket.amount;
            var success = false;
            async.whilst(
                function() { return !success},
                function(whileCb) {
                    stationTable.find({id:user.id}, {version:1, balance:1}).toArray(function(err, data){
                        var user = data[0];
                        stationTable.update({id:user.id, version:user.version},
                            {$inc:{balance:amount}, $set:{version:user.version + 1}}, {}, function(err, data){
                                if(data.updateCount == 1)
                                {
                                    success = true;
                                }
                                whileCb();
                            });
                    });
                },
                function(err) {
                    cb(null);
                }
            );
        },
        //sale station get the money.
        function(cb)
        {
            cb(null);
        }
    ], function(err) {
        cb(null, ticket, success);
    });
};



/**
 * 渠道购买彩票，进行扣款
 * @param stationId
 * @param amount
 * @param cb
 */
StationService.prototype.buyLot = function(stationId, amount, cb)
{
    var self = this;
    var stationTable = dc.main.get("station");
    transaction.run(function(wCb){
        async.waterfall([
            //find the station(查看投注站是否存在)
            function(cb){
                stationTable.find({id:stationId}, {version:1, balance:1}).toArray(function(err, data){
                    if(err)
                    {
                        cb(ec.E9999);
                    }
                    else
                    {
                        if(data.length == 0)
                        {
                            cb(ec.E2035);
                        }
                        else
                        {
                            cb(null, data[0]);
                        }
                    }
                });
            },
            //查看用户的余额是否足够
            function(station, cb)
            {
                if(station.balance < amount)
                {
                    cb(ec.E1007);
                }
                else
                {
                    cb(null, station);
                }
            },
            //decrease the money(扣款)
            function(station, cb){
                stationTable.update({id:station.id, version:station.version},
                    {$inc:{balance:amount*(-1)}, $set:{version:station.version + 1}}, {}, function(err, data){
                        if(err)
                        {
                            cb(ec.E9999);
                        }
                        else
                        {
                            if(data.affectedRows == 1)
                            {
                                station.balance = station.balance + amount;
                                station.version++;
                                cb(ec.E0000, station);
                            }
                            else
                            {
                                cb(ec.E9999);
                            }
                        }
                    });
            }
        ], function (err, result) {
            wCb(err, result);
        });
    }, function(err, data){
        cb(err, data);
    });
};

/**
 * 机构的账户操作
 * @param station
 * @param amount
 * @param cb
 */
StationService.prototype.money = function(station, amount, cb)
{
    var self = this;
    var table = dc.main.get("station");
    transaction.run(function(wCb){
        async.waterfall([
            //查找机构
            function(cb){
                var cond = {};
                if(station.id)
                {
                    cond.id = station.id;
                }
                else
                {
                    cond.code = station.code;
                }
                table.findOne(cond, {version:1, balance:1}, [], function(err, data){
                    if(err)
                    {
                        cb(ec.E9999);
                    }
                    else
                    {
                        if(!data)
                        {
                            cb(ec.E2035);
                        }
                        else
                        {
                            cb(null, data);
                        }
                    }
                });
            },
            //操作余额
            function(station, cb)
            {
                var cond = {id:station.id, version:station.version};
                station.version++;
                station.balance += amount;
                var data = {$set:{version:station.version, balance:station.balance}};
                table.update(cond, data, [], function(err, data){
                    if(err)
                    {
                        cb(ec.E9999);
                    }
                    else
                    {
                        if(data.affectedRows == 1)
                        {
                            cb(ec.E0000, station);
                        }
                        else
                        {
                            cb(ec.E9999);
                        }
                    }
                });
            }
        ], function (err, result) {
            wCb(err, result);
        });
    }, function(err, data){
        cb(err, data);
    });
};


var stationService = new StationService();
module.exports = stationService;