var CronJob = require("cron").CronJob;
var async = require('async');

var esut = require("easy_util");
var log = esut.log;

var dc = require('mcp_dao').dc;

var moment = require("moment");

var config = require('mcp_config');
var prop = config.prop;

var fs = require('fs');

var Check = require('./Check.js');

/**
 * 日结程序入口类，目前任务包括
 * 1.收集当天中奖票据，按如票渠道生成文件
 */
var DailyClear = function(cb)
{
    var self = this;
    self.cronTime = "0 5 0 * * *"; //日结触发的时间，cron表达式，凌晨5分触发
    //self.cronTime = "0 5 0 * * *";
    async.waterfall([
        function(cb)
        {
            dc.init(function(err){
                cb(err);
            });
        },
        function(cb)
        {
            self.start();
            cb(null, "start success!");
        }
    ], function (err, result) {
        if(err)
        {
            log.info(err);
        }
        else
        {
            log.info(result);
        }
        if(cb)
        {
            cb(err, result);
        }
    });
}


DailyClear.prototype.start = function()
{
    var self = this;
    var term = {gameCode:'F01', code:'2014001', winningNumber:'01,02,03,04,09,14|10'};
    var gl = {"grades":[{"code":"LV1","bonus":400000000,"name":"一等奖","gCount":2,"gLevel":1,"id":"1"},{"code":"LV2","bonus":100000000,"name":"二等奖","gCount":2,"gLevel":2,"id":"2"},{"code":"LV3","bonus":300000,"name":"三等奖","gCount":2,"gLevel":3,"id":"3"},{"code":"LV4","bonus":20000,"name":"四等奖","gCount":2,"gLevel":4,"id":"4"},{"code":"LV5","bonus":1000,"name":"五等奖","gCount":2,"gLevel":5,"id":"5"},{"code":"LV6","bonus":500,"name":"六等奖","gCount":2,"gLevel":6,"id":"6"}]};
    var checkTask = new Check(term, gl);

    async.waterfall([
        //对ticket进行算奖
        function(cb)
        {
            checkTask.checkTicket(function(err, data){
                cb(err);
            });
        },
        //统计信息
        function(cb)
        {
            checkTask.generateInfo(function(err, data){
                cb(err);
            });
        }
    ], function (err, rst) {
        log.info(err);
        log.info(rst);
    });
}

new DailyClear();



